import numpy as np
import matplotlib.pyplot as plt

# ----------------------------------------------------
# 1. Анықтамалар
# ----------------------------------------------------

# Интегралданатын функция: f(x) = x^2
def f(x):
    return x**2

# Дәл (аналитикалық) шешім (Салыстыру үшін)
def exact_integral(a, b):
    # I = [x^3 / 3]_a^b
    return (b**3 / 3.0) - (a**3 / 3.0)

# ----------------------------------------------------
# 2. Трапеция Әдісінің Функциясы
# ----------------------------------------------------

def trapezoidal_rule(f, a, b, n):
    """
    Құрама Трапеция Әдісі арқылы интегралды жуықтау.
    
    Параметрлер:
    f (function): Интегралданатын функция
    a (float): Төменгі шекара
    b (float): Жоғарғы шекара
    n (int): Бөліктер (аралықтар) саны
    
    Қайтарады:
    float: Жуықталған интеграл мәні
    """
    
    # Қадам 1 & 2: h мөлшерін есептеу
    h = (b - a) / n
    
    # Қадам 3: x_i түйінді нүктелерді анықтау
    x_values = np.linspace(a, b, n + 1)
    
    # Қадам 4: f(x_i) мәндерін есептеу
    y_values = f(x_values)
    
    # Қадам 5: Құрама Трапеция Формуласын Қолдану
    # I ≈ h/2 * [f(x0) + f(xn) + 2 * Sum(f(x1) ... f(xn-1))]
    
    # 1. Шеткі мүшелер: f(x0) + f(xn)
    integral_sum = y_values[0] + y_values[-1]
    
    # 2. Аралық мүшелер: 2 * Sum(f(xi))
    # y_values[1:-1] - бұл бірінші және соңғы элементтерді қоспй, ортадағы барлық элементтер
    integral_sum += 2 * np.sum(y_values[1:-1])
    
    # 3. h/2-ге көбейту
    approx_integral = (h / 2) * integral_sum
    
    return approx_integral, x_values, y_values

# ----------------------------------------------------
# 3. Параметрлерді Орнату және Есептеу
# ----------------------------------------------------

a = 1.0
b = 3.0
n = 4 # Бөліктер саны

# Трапеция әдісін іске қосу
I_approx, x_points, y_points = trapezoidal_rule(f, a, b, n)

# Дәл мәнді есептеу
I_exact = exact_integral(a, b)

# Қателікті есептеу
error = abs(I_exact - I_approx)

# ----------------------------------------------------
# 4. Нәтижелерді Консольге Шығару
# ----------------------------------------------------

print("--- Трапеция Әдісінің Нәтижелері ---")
print(f"Интеграл: ∫({a} - {b}) x^2 dx")
print("-" * 40)
print(f"Бөліктер саны (n): {n}")
print(f"Қадам мөлшері (h): {(b - a) / n:.4f}")
print("-" * 40)
print(f"Жуықталған мәні (Трапеция): {I_approx:.6f}")
print(f"Дәл мәні (Аналитикалық):    {I_exact:.6f}")
print(f"Абсолютті қателік:         {error:.6f}")
print("-" * 40)

# ----------------------------------------------------
# 5. Графикті Шығару (Трапецияларды көрсету)
# ----------------------------------------------------

plt.figure(figsize=(10, 6))

# Функцияны тегіс сызық ретінде көрсету (дәл қисық)
x_smooth = np.linspace(a, b, 100)
plt.plot(x_smooth, f(x_smooth), 'b-', label='$f(x) = x^2$')

# Трапециялардың жоғарғы жағын көрсету (жуықтау)
plt.plot(x_points, y_points, 'ro-', label='Трапециялық жуықтау нүктелері')

# Трапециялардың ауданын көрсету
for i in range(n):
    # Трапецияның төбелерінің координаталары
    x_coords = [x_points[i], x_points[i], x_points[i+1], x_points[i+1]]
    y_coords = [0, y_points[i], y_points[i+1], 0]
    plt.fill(x_coords, y_coords, 'r', alpha=0.2) # Қызыл түспен бояу

# График элементтерін қосу
plt.title(f'Трапеция Әдісімен Интегралды Жуықтау (n={n})')
plt.xlabel('x')
plt.ylabel('f(x)')
plt.legend()
plt.grid(True)
plt.show()